<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESpace - Create Event</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'washu-red': '#9D2235',
                        'washu-red-hover': '#8a1e30',
                        'washu-red-light': 'rgba(157, 34, 53, 0.1)',
                        'washu-red-border': 'rgba(157, 34, 53, 0.28)'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-washu-red mb-2">Create Event</h1>
            <p class="text-gray-600 text-lg">Fill out the form below to create your event</p>
        </header>

        <!-- Status Messages -->
        <div id="status-message" class="hidden p-4 mb-6 rounded-lg font-medium" aria-live="polite" aria-atomic="true"></div>

        <form id="event-form" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <!-- Event Name -->
            <div class="mb-6">
                <label for="event-name" class="block mb-2 font-semibold text-gray-900">Event Name *</label>
                <input 
                    type="text" 
                    id="event-name" 
                    name="eventName" 
                    required 
                    aria-describedby="event-name-error"
                    placeholder="Enter event name"
                    class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border"
                >
                <div id="event-name-error" class="hidden text-red-600 text-sm mt-1" role="alert"></div>
            </div>

            <!-- Tags -->
            <div class="mb-6">
                <label for="tags-input" class="block mb-2 font-semibold text-gray-900">Tags</label>
                <div class="border-2 border-gray-300 rounded-lg p-2 min-h-12 bg-white">
                    <div id="tags-display" class="flex flex-wrap gap-2 mb-2"></div>
                    <input 
                        type="text" 
                        id="tags-input" 
                        placeholder="Type a tag and press Enter"
                        aria-describedby="tags-help"
                        class="border-none p-2 text-base bg-transparent w-full focus:outline-none"
                    >
                </div>
                <div id="tags-help" class="text-gray-600 text-sm mt-1">Press Enter to add a tag, click × to remove</div>
            </div>

            <!-- Event Time -->
            <div class="mb-6">
                <label for="start-time" class="block mb-2 font-semibold text-gray-900">Event Time *</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label for="start-time" class="text-sm mb-1">Start Time</label>
                        <input 
                            type="datetime-local" 
                            id="start-time" 
                            name="startTime" 
                            required
                            aria-describedby="start-time-error"
                            class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border"
                        >
                        <div id="start-time-error" class="hidden text-red-600 text-sm mt-1" role="alert"></div>
                    </div>
                    <div class="flex flex-col">
                        <label for="end-time" class="text-sm mb-1">End Time</label>
                        <input 
                            type="datetime-local" 
                            id="end-time" 
                            name="endTime" 
                            required
                            aria-describedby="end-time-error"
                            class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border"
                        >
                        <div id="end-time-error" class="hidden text-red-600 text-sm mt-1" role="alert"></div>
                    </div>
                </div>
            </div>

            <!-- Location -->
            <div class="mb-6">
                <label for="location" class="block mb-2 font-semibold text-gray-900">Location *</label>
                <input 
                    type="text" 
                    id="location" 
                    name="location" 
                    required
                    aria-describedby="location-error"
                    placeholder="Enter event location"
                    class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border"
                >
                <div id="location-error" class="hidden text-red-600 text-sm mt-1" role="alert"></div>
            </div>

            <!-- Capacity -->
            <div class="mb-6">
                <label for="capacity" class="block mb-2 font-semibold text-gray-900">Capacity *</label>
                <input 
                    type="number" 
                    id="capacity" 
                    name="capacity" 
                    min="0"
                    aria-describedby="capacity-help capacity-error"
                    placeholder="0 for unlimited"
                    class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border"
                >
                <div id="capacity-help" class="text-gray-600 text-sm mt-1">Enter 0 for unlimited capacity</div>
                <div id="capacity-error" class="hidden text-red-600 text-sm mt-1" role="alert"></div>
            </div>

            <!-- Description -->
            <div class="mb-6">
                <label for="description" class="block mb-2 font-semibold text-gray-900">Description</label>
                <textarea 
                    id="description" 
                    name="description" 
                    rows="4"
                    aria-describedby="description-help"
                    placeholder="Describe your event..."
                    class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border resize-vertical"
                ></textarea>
                <div id="description-help" class="text-gray-600 text-sm mt-1">Optional description of your event</div>
            </div>

            <!-- Promo Photo -->
            <div class="mb-6">
                <label for="promo-photo" class="block mb-2 font-semibold text-gray-900">Promo Photo</label>
                <input 
                    type="file" 
                    id="promo-photo" 
                    name="promoPhoto" 
                    accept="image/jpeg,image/png,image/webp"
                    aria-describedby="photo-help photo-error photo-preview"
                    class="w-full px-3 py-3 border-2 border-gray-300 rounded-lg text-base bg-white text-gray-900 transition-colors duration-200 focus:outline-none focus:border-washu-red focus:ring-3 focus:ring-washu-red-border file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-washu-red file:text-white hover:file:bg-washu-red-hover"
                >
                <div id="photo-help" class="text-gray-600 text-sm mt-1">JPG, PNG, or WebP format, max 5MB</div>
                <div id="photo-error" class="hidden text-red-600 text-sm mt-1" role="alert"></div>
                <div id="photo-preview" class="mt-4 text-center"></div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-end mt-8 pt-6 border-t border-gray-200">
                <button type="button" id="save-draft" class="px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-900 bg-transparent hover:bg-gray-50 hover:border-washu-red hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-washu-red focus:ring-offset-2">Save Draft</button>
                <button type="button" id="publish-event" class="px-6 py-3 bg-washu-red text-white rounded-lg font-semibold hover:bg-washu-red-hover hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-washu-red focus:ring-offset-2 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-none" disabled>Publish Event</button>
            </div>
        </form>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" role="dialog" aria-labelledby="success-title" aria-describedby="success-message">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-11/12 text-center">
            <h2 id="success-title" class="text-green-600 mb-4 text-2xl font-bold">Event Published Successfully!</h2>
            <p id="success-message" class="text-gray-600 mb-6">Do you want to return to the homepage?</p>
            <div class="flex flex-col gap-4 items-center">
                <button id="return-home" class="px-6 py-3 bg-washu-red text-white rounded-lg font-semibold hover:bg-washu-red-hover hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-washu-red focus:ring-offset-2">Return Now</button>
                <div id="countdown" class="text-gray-600 text-sm">Redirecting in <span id="countdown-number" class="font-semibold">3</span> seconds...</div>
            </div>
        </div>
    </div>

    <script>
        // ESpace Create Event - Main JavaScript
        class EventForm {
            constructor() {
                this.form = document.getElementById('event-form');
                this.statusMessage = document.getElementById('status-message');
                this.successModal = document.getElementById('success-modal');
                this.countdownElement = document.getElementById('countdown-number');
                this.publishButton = document.getElementById('publish-event');
                this.saveButton = document.getElementById('save-draft');
                this.returnHomeButton = document.getElementById('return-home');
                
                this.tags = [];
                this.countdownTimer = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadDraft();
                this.validateForm();
            }
            
            setupEventListeners() {
                // Form validation on input
                this.form.addEventListener('input', () => this.validateForm());
                this.form.addEventListener('change', () => this.validateForm());
                
                // Tags functionality
                const tagsInput = document.getElementById('tags-input');
                tagsInput.addEventListener('keypress', (e) => this.handleTagInput(e));
                
                // Photo upload
                const photoInput = document.getElementById('promo-photo');
                photoInput.addEventListener('change', (e) => this.handlePhotoUpload(e));
                
                // Buttons
                this.saveButton.addEventListener('click', () => this.saveDraft());
                this.publishButton.addEventListener('click', () => this.publishEvent());
                this.returnHomeButton.addEventListener('click', () => this.returnToHome());
                
                // Modal close on outside click
                this.successModal.addEventListener('click', (e) => {
                    if (e.target === this.successModal) {
                        this.hideModal();
                    }
                });
            }
            
            handleTagInput(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = e.target.value.trim();
                    if (value && !this.tags.includes(value)) {
                        this.tags.push(value);
                        this.renderTags();
                        e.target.value = '';
                    }
                }
            }
            
            renderTags() {
                const tagsDisplay = document.getElementById('tags-display');
                tagsDisplay.innerHTML = this.tags.map(tag => `
                    <span class="bg-washu-red text-white px-2 py-1 rounded text-sm flex items-center gap-2">
                        ${tag}
                        <button type="button" class="bg-transparent border-none text-white cursor-pointer text-lg leading-none p-0 w-5 h-5 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20 transition-colors duration-200" onclick="eventForm.removeTag('${tag}')" aria-label="Remove ${tag} tag">×</button>
                    </span>
                `).join('');
            }
            
            removeTag(tag) {
                this.tags = this.tags.filter(t => t !== tag);
                this.renderTags();
                this.validateForm();
            }
            
            handlePhotoUpload(e) {
                const file = e.target.files[0];
                const errorElement = document.getElementById('photo-error');
                const previewElement = document.getElementById('photo-preview');
                
                // Clear previous errors and preview
                errorElement.textContent = '';
                errorElement.classList.add('hidden');
                previewElement.innerHTML = '';
                
                if (!file) return;
                
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    this.showError('photo-error', 'Please select a JPG, PNG, or WebP image.');
                    return;
                }
                
                // Validate file size (5MB = 5 * 1024 * 1024 bytes)
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    this.showError('photo-error', 'File size must be less than 5MB.');
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewElement.innerHTML = `<img src="${e.target.result}" alt="Photo preview" class="max-w-xs max-h-xs rounded-lg shadow-md mx-auto">`;
                };
                reader.readAsDataURL(file);
            }
            
            validateForm() {
                const requiredFields = ['event-name', 'start-time', 'end-time', 'location'];
                let isValid = true;
                
                // Clear all errors
                document.querySelectorAll('[id$="-error"]').forEach(error => {
                    error.classList.add('hidden');
                    error.textContent = '';
                });
                
                // Validate required fields
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        this.showError(`${fieldId}-error`, 'This field is required.');
                        isValid = false;
                    }
                });
                
                // Validate capacity (REQUIRED, allow 0)
                const capacity = document.getElementById('capacity');
                const rawCap = capacity.value.trim();
                if (rawCap === '') {
                    this.showError('capacity-error', 'This field is required.');
                    isValid = false;
                } else {
                    const n = Number(rawCap);
                    if (!Number.isInteger(n) || n < 0) {
                        this.showError('capacity-error', 'Capacity must be an integer ≥ 0 (0 for unlimited).');
                        isValid = false;
                    }
                }

                // Validate time range
                const startTime = document.getElementById('start-time');
                const endTime = document.getElementById('end-time');
                if (startTime.value && endTime.value) {
                    const start = new Date(startTime.value);
                    const end = new Date(endTime.value);
                    if (end <= start) {
                        this.showError('end-time-error', 'End time must be after start time.');
                        isValid = false;
                    }
                }
                
                // Enable/disable publish button
                this.publishButton.disabled = !isValid;
                
                return isValid;
            }
            
            showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
            
            getFormData() {
                const formData = new FormData(this.form);
                return {
                    eventName: formData.get('eventName'),
                    tags: [...this.tags],
                    startTime: formData.get('startTime'),
                    endTime: formData.get('endTime'),
                    location: formData.get('location'),
                    capacity: Number(formData.get('capacity')),
                    description: formData.get('description'),
                    promoPhoto: formData.get('promoPhoto')
                };
            }
            
            saveDraft() {
                const formData = this.getFormData();
                try {
                    localStorage.setItem('espace:draft', JSON.stringify(formData));
                    this.showStatusMessage('Draft saved successfully.', 'success');
                } catch (error) {
                    this.showStatusMessage('Failed to save draft.', 'error');
                }
            }
            
            loadDraft() {
                try {
                    const draft = localStorage.getItem('espace:draft');
                    if (draft) {
                        const formData = JSON.parse(draft);
                        this.populateForm(formData);
                    }
                } catch (error) {
                    console.error('Failed to load draft:', error);
                }
            }
            
            populateForm(formData) {
                if (formData.eventName) document.getElementById('event-name').value = formData.eventName;
                if (formData.startTime) document.getElementById('start-time').value = formData.startTime;
                if (formData.endTime) document.getElementById('end-time').value = formData.endTime;
                if (formData.location) document.getElementById('location').value = formData.location;
                if (formData.capacity !== undefined && formData.capacity !== null) {
                    document.getElementById('capacity').value = formData.capacity;
                }        
                if (formData.description) document.getElementById('description').value = formData.description;
                if (formData.tags) {
                    this.tags = formData.tags;
                    this.renderTags();
                }
            }
            
            publishEvent() {
                if (!this.validateForm()) {
                    return;
                }
                
                const formData = this.getFormData();
                
                // Clear draft from localStorage
                localStorage.removeItem('espace:draft');
                
                // Show success modal
                this.showModal();
                
                // Start countdown
                this.startCountdown();
            }
            
            showModal() {
                this.successModal.classList.remove('hidden');
                this.successModal.setAttribute('aria-hidden', 'false');
            }
            
            hideModal() {
                this.successModal.classList.add('hidden');
                this.successModal.setAttribute('aria-hidden', 'true');
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                }
            }
            
            startCountdown() {
                let countdown = 3;
                this.countdownElement.textContent = countdown;
                
                this.countdownTimer = setInterval(() => {
                    countdown--;
                    this.countdownElement.textContent = countdown;
                    
                    if (countdown <= 0) {
                        this.returnToHome();
                    }
                }, 1000);
            }
            
            returnToHome() {
                window.location.href = '/';
            }
            
            showStatusMessage(message, type) {
                this.statusMessage.textContent = message;
                this.statusMessage.className = `p-4 mb-6 rounded-lg font-medium ${type === 'success' ? 'bg-washu-red-light text-green-600 border border-green-600' : 'bg-red-100 text-red-600 border border-red-600'}`;
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    this.statusMessage.className = 'hidden p-4 mb-6 rounded-lg font-medium';
                }, 3000);
            }
        }

        // Initialize the form when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.eventForm = new EventForm();
        });
    </script>
</body>
</html>
